<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste de Câmera</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      video {
        width: 100%;
        max-width: 400px;
        margin-top: 20px;
        border: 2px solid #000;
      }
      .info {
        margin-top: 20px;
        font-size: 16px;
        color: #555;
      }
      #photo {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 50%;
        max-height: 50%;
        border-radius: 10px;
        border: 2px solid #000;
        display: none;
      }
      .color-info {
        margin-top: 20px;
        font-size: 18px;
        color: #555;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .overlay-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        max-width: 400px;
        width: 80%;
      }
      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>Teste de Câmera</h1>
    <video id="video" autoplay playsinline></video>
    <div class="info">Se a câmera não abrir, verifique as permissões do navegador.</div>
    <div class="color-info" id="color-info"></div>
    <img id="photo" alt="Foto tirada" />

    <!-- Tela de sobreposição -->
    <div id="overlay" class="overlay">
      <div class="overlay-content">
        <h2>Permitir acesso à câmera</h2>
        <p>Para continuar, por favor, permita o acesso à sua câmera.</p>
        <button id="allow-button">Permitir acesso</button>
      </div>
    </div>

    <button id="capture-button">Tirar Foto</button>

    <script>
      let currentStream = null;
      let videoElement = document.getElementById("video");
      let photoElement = document.getElementById("photo");
      let colorInfoElement = document.getElementById("color-info");
      let overlayElement = document.getElementById("overlay");
      let allowButton = document.getElementById("allow-button");
      let captureButton = document.getElementById("capture-button");

      // Função para iniciar a câmera
      async function startCamera(camera = "environment") {
        try {
          // Solicita o acesso à câmera
          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
          }

          currentStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: camera }, // Usa a câmera especificada
            audio: false,
          });

          // Exibe o vídeo no elemento <video>
          videoElement.srcObject = currentStream;
          overlayElement.style.display = "none"; // Esconde o overlay quando a câmera começa a funcionar
        } catch (err) {
          // Exibe o erro no console e alerta o usuário
          console.error("Erro ao acessar a câmera:", err);
          alert("Não foi possível acessar a câmera. Verifique as permissões do navegador.");
        }
      }

      // Função para capturar a foto manualmente
      captureButton.addEventListener("click", capturePhoto);

      function capturePhoto() {
        // Cria um canvas para capturar a imagem
        let canvas = document.createElement("canvas");
        let context = canvas.getContext("2d");
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

        // Exibe a foto no centro da tela
        let dataUrl = canvas.toDataURL("image/png");
        photoElement.src = dataUrl;
        photoElement.style.display = "block";

        // Obtém a cor dominante da foto
        getDominantColor(canvas);
      }

      // Função para calcular a cor dominante da imagem
      function getDominantColor(canvas) {
        let context = canvas.getContext("2d");
        let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        let data = imageData.data;

        let r = 0,
          g = 0,
          b = 0;

        // Itera sobre cada pixel da imagem para calcular a média das cores
        for (let i = 0; i < data.length; i += 4) {
          r += data[i]; // Red
          g += data[i + 1]; // Green
          b += data[i + 2]; // Blue
        }

        // Calcula a média das cores
        let pixelCount = data.length / 4;
        r = Math.floor(r / pixelCount);
        g = Math.floor(g / pixelCount);
        b = Math.floor(b / pixelCount);

        // Exibe a cor dominante
        let color = `rgb(${r}, ${g}, ${b})`;
        colorInfoElement.textContent = `Cor dominante: ${color}`;
        colorInfoElement.style.color = color;

        // Chama a função para identificar o cabo RJ45
        identifyRJ45Color(color);
      }

      // Função para identificar o padrão de cores do cabo RJ45
      function identifyRJ45Color(color) {
        const colorNames = {
          "rgb(255, 255, 255)": "Branco",
          "rgb(0, 255, 0)": "Verde",
          "rgb(0, 128, 0)": "Verde Escuro",
          "rgb(0, 0, 255)": "Azul",
          "rgb(255, 165, 0)": "Laranja",
          "rgb(128, 0, 0)": "Marrom",
        };

        let identifiedColor = colorNames[color] || "Desconhecida";

        colorInfoElement.textContent = `Cor identificada: ${identifiedColor}`;
        colorInfoElement.style.color = color;
      }

      // Função para permitir o acesso à câmera
      allowButton.addEventListener("click", () => {
        // Remove a tela de sobreposição
        overlayElement.style.display = "none";

        // Inicia a câmera
        startCamera("environment");
      });
    </script>
  </body>
</html>